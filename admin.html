<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DND HQ | Master Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { background: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; margin: 0; transition: all 0.3s ease; }
        #master-content { display: none; }
        .authorized #master-content { display: flex !important; }
        .authorized #admin-lock-screen { display: none !important; }

        .sidebar-btn.active { background: #1e3a8a; color: white; border-left: 4px solid #f97316; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* WAYBILL PRINT STYLES */
        #waybill-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #waybill-area, #waybill-area * { visibility: visible; }
            #waybill-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen custom-scrollbar">

    <div id="admin-lock-screen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6">
        <div class="w-full max-w-md text-center">
            <div class="mb-8">
                <div class="w-20 h-20 bg-orange-500 rounded-3xl mx-auto flex items-center justify-center shadow-2xl shadow-orange-500/20 mb-4 rotate-3">
                    <i class="fas fa-shield-halved text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-white italic">DND <span class="text-orange-500">MASTER</span></h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] mt-2">Restricted Command Center</p>
            </div>

            <div class="glass-panel p-8 rounded-[2.5rem] shadow-2xl">
                <p class="text-slate-500 text-xs font-bold mb-6 uppercase">Identity Verification Required</p>
                <div class="space-y-4">
                    <div class="relative">
                        <i class="fas fa-key absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="password" id="adminPassInput" placeholder="Enter Admin Key" 
                               class="w-full bg-slate-100 border-none rounded-2xl py-5 pl-14 pr-6 font-bold text-blue-900 outline-none focus:ring-2 ring-orange-500 transition-all">
                    </div>
                    <button id="loginBtn" onclick="verifyAdmin()" class="w-full bg-blue-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-800 transition active:scale-95 shadow-xl shadow-blue-900/20">
                        Access Terminal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="master-content" class="min-h-screen w-full">
        
        <div id="waybill-area" class="p-8 bg-white border-2 border-dashed border-blue-900 rounded-lg">
            <div class="flex justify-between items-start border-b-2 border-blue-900 pb-4 mb-6">
                <div>
                    <h1 class="text-3xl font-black text-blue-900 uppercase">DND GLOBAL</h1>
                    <p class="text-xs font-bold tracking-widest text-orange-500 uppercase">Logistics & Executive Hire</p>
                </div>
                <div class="text-right">
                    <p id="wb_id" class="text-xl font-black text-blue-900"></p>
                    <p id="wb_date" class="text-xs font-bold text-slate-500"></p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-8 mb-8">
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="text-[10px] font-black text-blue-900 uppercase mb-2 border-b border-blue-200">Client / Sender Details</h3>
                    <p id="wb_name" class="font-bold text-sm"></p>
                    <p id="wb_contact" class="text-xs text-slate-600"></p>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="text-[10px] font-black text-blue-900 uppercase mb-2 border-b border-blue-200">Logistics / Route</h3>
                    <p id="wb_route" class="text-xs font-bold"></p>
                </div>
            </div>
            <div class="border-2 border-blue-900 p-4 rounded-lg">
                <h3 class="text-[10px] font-black text-blue-900 uppercase mb-2">Item Description / Vehicle Details</h3>
                <p id="wb_details" class="text-sm font-semibold italic text-slate-700"></p>
            </div>
            <div class="mt-12 text-center border-t pt-4">
                <p class="text-[9px] font-bold text-slate-400 uppercase">This is an electronically generated document from DND Master Control</p>
            </div>
        </div>

        <aside class="w-72 bg-white border-r border-slate-200 p-6 flex flex-col hidden lg:flex">
            <div class="mb-10">
                <h1 class="text-2xl font-black text-blue-900 italic">DND <span class="text-orange-500">GLOBAL</span></h1>
            </div>
            <nav class="space-y-2 flex-1">
                <button onclick="switchTab('Database', '1EkIYrBFcskSwS6PhMhj6dKCXHok8NfWanUb0lUqmM8I')" id="btn-Database" class="w-full flex items-center gap-4 p-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 sidebar-btn">
                    <i class="fas fa-box"></i> Item Logistics
                </button>
                <button onclick="switchTab('CarHire', '1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0')" id="btn-CarHire" class="w-full flex items-center gap-4 p-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 sidebar-btn active">
                    <i class="fas fa-car-side"></i> Executive Hire
                </button>
                <button onclick="switchTab('drivers', '1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0')" id="btn-drivers" class="w-full flex items-center gap-4 p-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 sidebar-btn">
                    <i class="fas fa-satellite-dish"></i> Fleet Radar
                </button>
                <button onclick="switchTab('History', '1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0')" id="btn-History" class="w-full flex items-center gap-4 p-4 rounded-xl font-bold text-slate-500 hover:bg-slate-50 sidebar-btn">
                    <i class="fas fa-history"></i> History Log
                </button>
                <button onclick="logout()" class="w-full flex items-center gap-4 p-4 rounded-xl font-bold text-red-500 hover:bg-red-50 mt-10">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white border-b border-slate-200 p-8 flex justify-between items-center">
                <div>
                    <h2 id="viewTitle" class="text-2xl font-black text-blue-900 uppercase">Master Control</h2>
                    <div class="flex gap-4 mt-2">
                        <a href="https://docs.google.com/spreadsheets/d/1EkIYrBFcskSwS6PhMhj6dKCXHok8NfWanUb0lUqmM8I/edit" target="_blank" class="text-[10px] font-black text-blue-600 hover:underline"><i class="fas fa-table mr-1"></i> ITEM SHEET</a>
                        <a href="https://docs.google.com/spreadsheets/d/1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0/edit" target="_blank" class="text-[10px] font-black text-orange-600 hover:underline"><i class="fas fa-table mr-1"></i> HIRE SHEET</a>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <div class="hidden md:flex items-center gap-3 bg-blue-50 px-4 py-2 rounded-2xl border border-blue-100">
                        <div class="w-8 h-8 bg-blue-900 rounded-full flex items-center justify-center text-white text-xs">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest leading-none">Active Session</p>
                            <p id="adminDisplayName" class="text-sm font-bold text-blue-900">Admin Terminal</p>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search..." class="bg-slate-100 rounded-xl px-6 py-3 text-sm outline-none w-64 focus:ring-2 ring-orange-500">
                        <button onclick="syncData()" class="bg-orange-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-200">
                            <i id="sync-icon" class="fas fa-sync-alt mr-2"></i> REFRESH
                        </button>
                    </div>
                </div>
            </header>

            <div class="p-8 pb-0 overflow-y-auto">
                <div id="revenueSection" class="hidden mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-2">Gross Revenue</h3>
                            <p id="totalRevDisplay" class="text-2xl font-black text-blue-900">₦0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <h3 class="text-[10px] font-black text-red-400 uppercase mb-2">Driver Expenses</h3>
                            <p id="totalExpDisplay" class="text-2xl font-black text-red-600">₦0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2rem] border border-orange-200 shadow-sm bg-orange-50">
                            <h3 class="text-[10px] font-black text-orange-500 uppercase mb-2">Net Profit</h3>
                            <p id="netProfitDisplay" class="text-2xl font-black text-orange-600">₦0.00</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 h-64">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div id="historyControls" class="hidden mb-6 flex justify-between items-center bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" class="w-6 h-6 rounded-lg accent-orange-500">
                            <span class="font-black text-slate-600 uppercase text-xs tracking-wider">Select All Records</span>
                        </label>
                    </div>
                    <button onclick="exportSelectedCSV()" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl shadow-emerald-200 hover:bg-emerald-700 transition transform active:scale-95">
                        <i class="fas fa-file-export mr-2"></i> EXPORT SELECTED (.CSV)
                    </button>
                </div>

                <div class="bg-white rounded-[2rem] border border-slate-200 overflow-hidden shadow-sm mb-12">
                    <table class="w-full text-left">
                        <thead id="tableHeader" class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b"></thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const MASTER_SCRIPT = 'https://script.google.com/macros/s/AKfycbxBqU-yWF2S9ltyKNmrZzP0nXl45gfMhD3X1q1SWfulkmlxPXkq7Tm5Hm6YiXtYi9KMKg/exec';
        let currentSheetID = '1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0';
        let currentTab = 'CarHire';
        let allData = [];
        let driversData = [];
        let historyData = [];
        let revenueChart = null;

        // AUTHENTICATION
        async function verifyAdmin() {
            const accessKey = document.getElementById('adminPassInput').value;
            if (!accessKey) return alert("Enter key");
            try {
                const response = await fetch(`${MASTER_SCRIPT}?action=login&key=${encodeURIComponent(accessKey)}&type=admin`);
                const result = await response.json();
                if (result.success) {
                    document.getElementById('adminDisplayName').innerText = result.name;
                    document.body.classList.add('authorized');
                    syncData();
                } else { alert("Access Denied."); }
            } catch (e) { alert("Server Error."); }
        }

        // DATA SYNC
        async function syncData() {
            const icon = document.getElementById('sync-icon');
            if(icon) icon.classList.add('fa-spin');
            
            try {
                const [dRes, hRes, tRes] = await Promise.all([
                    fetch(`https://docs.google.com/spreadsheets/d/1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0/gviz/tq?tqx=out:json&sheet=drivers`),
                    fetch(`https://docs.google.com/spreadsheets/d/1Q36QdZCbUw9LH1zScGH_-P9k5xnhOapKqcAsAvBSMI0/gviz/tq?tqx=out:json&sheet=History`),
                    fetch(`https://docs.google.com/spreadsheets/d/${currentSheetID}/gviz/tq?tqx=out:json&sheet=${currentTab}`)
                ]);

                const dText = await dRes.text();
                const hText = await hRes.text();
                const tText = await tRes.text();

                driversData = JSON.parse(dText.substring(47).slice(0, -2)).table.rows;
                historyData = JSON.parse(hText.substring(47).slice(0, -2)).table.rows;
                allData = JSON.parse(tText.substring(47).slice(0, -2)).table.rows;

                renderTable();
                if(currentTab === 'History') updateRevenueDashboard();
            } catch (e) { console.error("Sync Error", e); }
            if(icon) icon.classList.remove('fa-spin');
        }

        // TAB SWITCHING
        function switchTab(tab, id) {
            currentTab = tab; 
            currentSheetID = id;
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tab}`).classList.add('active');
            
            document.getElementById('historyControls').style.display = (tab === 'History') ? 'flex' : 'none';
            document.getElementById('revenueSection').style.display = (tab === 'History') ? 'block' : 'none';
            
            syncData();
        }

        // RENDER TABLE CONTENT
        function renderTable() {
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            body.innerHTML = '';

            if (currentTab === 'CarHire') {
                header.innerHTML = `<tr><th class="p-6">Hire ID</th><th>Customer</th><th>Vehicle</th><th class="text-right p-6">Management</th></tr>`;
            } else if (currentTab === 'drivers') {
                header.innerHTML = `<tr><th class="p-6">Driver ID</th><th>Name</th><th>Status</th><th>Active Job</th><th class="text-right p-6">Tracking</th></tr>`;
            } else if (currentTab === 'History') {
                header.innerHTML = `<tr><th class="p-6 w-10">Select</th><th>Date</th><th>Driver ID</th><th>Hire ID</th><th class="text-right p-6">Status</th></tr>`;
            } else if (currentTab === 'Database') {
                header.innerHTML = `<tr><th class="p-6">ID</th><th>Date</th><th>Customer</th><th>Route</th><th class="text-right p-6">Action</th></tr>`;
            }

            allData.slice().reverse().forEach((row, idx) => {
                const c = row.c;
                if (!c || !c[0]) return;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100";

                if (currentTab === 'CarHire') {
                    const hId = c[1].v;
                    const isArchived = historyData.some(h => h.c[2] && h.c[2].v == hId);
                    const assigned = driversData.find(d => d.c[7] && d.c[7].v == hId);
                    
                    let action = `<button onclick="allocateDriver('${hId}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-black shadow-md">ASSIGN</button>`;
                    if(isArchived) action = `<button class="bg-slate-800 text-slate-300 px-4 py-2 rounded-xl text-[10px] font-black" disabled>ARCHIVED</button>`;
                    else if(assigned) action = `<button onclick="completeJob('${assigned.c[0].v}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-md">DONE</button>`;

                    tr.innerHTML = `
                        <td class="p-6 font-black text-blue-900">${hId}</td>
                        <td class="p-6 font-bold text-slate-700">${c[2].v}</td>
                        <td class="p-6 text-xs font-black text-slate-400 uppercase">${c[4].v}</td>
                        <td class="p-6 text-right flex justify-end gap-2">
                            ${action}
                            <button onclick="printWaybillFromAdmin(${allData.length - 1 - idx})" class="bg-blue-900 text-white px-3 py-2 rounded-lg text-xs"><i class="fas fa-print"></i></button>
                        </td>`;
                } 
                else if (currentTab === 'History') {
                    tr.innerHTML = `
                        <td class="p-6"><input type="checkbox" class="row-select w-6 h-6 accent-orange-500" data-idx="${allData.length - 1 - idx}"></td>
                        <td class="p-6 text-xs text-slate-500 font-bold">${c[0].f || c[0].v}</td>
                        <td class="p-6 font-black text-slate-700">${c[1].v}</td>
                        <td class="p-6 font-black text-blue-700 uppercase">${c[2].v}</td>
                        <td class="p-6 text-right"><span class="text-green-600 text-[10px] font-black uppercase"><i class="fas fa-check-circle mr-1"></i> LOGGED</span></td>`;
                }
                else if (currentTab === 'drivers') {
                    const active = c[7] ? c[7].v : 'NONE';
                    tr.innerHTML = `
                        <td class="p-6 font-black text-blue-900">${c[0].v}</td>
                        <td class="p-6 font-bold text-slate-700">${c[1].v}</td>
                        <td class="p-6"><span class="px-3 py-1 rounded-full text-[10px] font-black bg-green-100 text-green-600">LIVE</span></td>
                        <td class="p-6 font-black text-blue-600 text-xs">${active}</td>
                        <td class="p-6 text-right">
                            <a href="https://www.google.com/maps?q=${c[5].v},${c[6].v}" target="_blank" class="bg-blue-900 text-white px-4 py-2 rounded-xl text-[10px] font-black">TRACK</a>
                        </td>`;
                }
                else if (currentTab === 'Database') {
                    tr.innerHTML = `
                        <td class="p-6 font-black text-blue-900">${c[0].v}</td>
                        <td class="p-6 font-bold text-slate-500 text-xs">${c[1].v}</td>
                        <td class="p-6 font-bold text-slate-700">${c[3].v}</td>
                        <td class="p-6 text-xs font-black text-slate-400 uppercase">${c[7].v} -> ${c[8].v}</td>
                        <td class="p-6 text-right">
                            <button onclick="printWaybillFromAdmin(${allData.length - 1 - idx})" class="bg-blue-900 text-white px-3 py-2 rounded-lg text-xs"><i class="fas fa-print"></i></button>
                        </td>`;
                }
                body.appendChild(tr);
            });
        }

        // ASSIGNMENT & COMPLETION COMMANDS
        async function allocateDriver(hId) {
            const dId = prompt("Enter Driver ID to Assign:");
            if(!dId) return;
            const url = `${MASTER_SCRIPT}?isAssign=true&DriverID=${encodeURIComponent(dId)}&HireID=${encodeURIComponent(hId)}`;
            await fetch(url, { mode: 'no-cors' });
            alert("Assignment Sent.");
            setTimeout(syncData, 1500);
        }

        async function completeJob(dId) {
            if(!confirm("Mark this job as complete?")) return;
            const url = `${MASTER_SCRIPT}?isCompleteJob=true&DriverID=${encodeURIComponent(dId)}`;
            await fetch(url, { mode: 'no-cors' });
            alert("Completion Logged.");
            setTimeout(syncData, 1500);
        }

        // EXPORT LOGIC
        function toggleSelectAll(master) {
            document.querySelectorAll('.row-select').forEach(cb => cb.checked = master.checked);
        }

        function exportSelectedCSV() {
            const selected = Array.from(document.querySelectorAll('.row-select:checked'));
            if(selected.length === 0) return alert("Select records first.");
            
            let csv = "Date,Driver ID,Hire ID,Revenue,Expense\n";
            selected.forEach(cb => {
                const row = allData[cb.getAttribute('data-idx')].c;
                csv += `"${row[0].f || row[0].v}","${row[1].v}","${row[2].v}","${row[5] ? row[5].v : 0}","${row[6] ? row[6].v : 0}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `DND_Export_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // DASHBOARD & CHART
        function updateRevenueDashboard() {
            let totalRev = 0, totalExp = 0;
            const dailyData = {};

            historyData.forEach(row => {
                if(!row.c) return;
                const r = row.c[5] ? parseFloat(row.c[5].v) : 0;
                const e = row.c[6] ? parseFloat(row.c[6].v) : 0;
                totalRev += r; totalExp += e;

                const date = row.c[0].f || "Unknown";
                dailyData[date] = (dailyData[date] || 0) + (r - e);
            });

            document.getElementById('totalRevDisplay').innerText = `₦${totalRev.toLocaleString()}`;
            document.getElementById('totalExpDisplay').innerText = `₦${totalExp.toLocaleString()}`;
            document.getElementById('netProfitDisplay').innerText = `₦${(totalRev - totalExp).toLocaleString()}`;

            // Chart Generation
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyData),
                    datasets: [{
                        label: 'Net Profit',
                        data: Object.values(dailyData),
                        borderColor: '#f97316',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(249, 115, 22, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // WAYBILL PRINTING
        function printWaybillFromAdmin(idx) {
            const row = allData[idx].c;
            if (currentTab === 'Database') {
                document.getElementById('wb_id').innerText = "TRACKING: " + row[0].v;
                document.getElementById('wb_name').innerText = row[3].v;
                document.getElementById('wb_contact').innerText = "Phone: " + row[4].v;
                document.getElementById('wb_route').innerText = `FROM: ${row[7].v} -> TO: ${row[8].v}`;
                document.getElementById('wb_details').innerText = row[9] ? row[9].v : "DND Item Logistics";
            } else {
                document.getElementById('wb_id').innerText = "HIRE: " + row[1].v;
                document.getElementById('wb_name').innerText = row[2].v;
                document.getElementById('wb_contact').innerText = "Phone: " + row[3].v;
                document.getElementById('wb_route').innerText = `VEHICLE: ${row[4].v}`;
                document.getElementById('wb_details').innerText = `Rental Duration: ${row[5].v} Days`;
            }
            window.print();
        }

        function filterTable() {
            const val = document.getElementById('searchInput').value.toUpperCase();
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none";
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
